# -*- coding: utf-8 -*-
# core/llm_guardrails.py (Ultimate Final Version - Revised for PDCA Routing)

import re
from typing import Dict, Any, List, Optional
import logging

from config.global_vars import (
    SUPPORTED_ENABLERS,
    DEFAULT_ENABLER,
    PDCA_ANALYSIS_SIGNALS,
    ANALYSIS_FRAMEWORK
)

logger = logging.getLogger(__name__)

# ======================================================================
# Intent Detection (Full Production Version with Enhanced Analysis Routing)
# ======================================================================

def detect_intent(
    question: str,
    user_context: Optional[List[Dict[str, Any]]] = None  # conversation history
) -> Dict[str, Any]:
    """
    à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸„à¸§à¸²à¸¡à¸•à¸±à¹‰à¸‡à¹ƒà¸ˆà¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰ (Intent) - à¸‰à¸šà¸±à¸šà¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹€à¸à¸·à¹ˆà¸­à¹à¸¢à¸ Summary à¸­à¸­à¸à¸ˆà¸²à¸ Analysis
    """
    q = question.strip().lower()
    intent = {
        "is_greeting": False,
        "is_capabilities": False,    
        "is_faq": False,
        "is_summary": False,
        "is_comparison": False,
        "is_analysis": False,
        "is_criteria_query": False,
        "sub_topic": None,
        "enabler_hint": None,
    }

    # --- 1. à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸š Summary à¸à¹ˆà¸­à¸™ (Priority High) ---
    # à¸–à¹‰à¸²à¸¡à¸µà¸„à¸³à¸à¸¥à¸¸à¹ˆà¸¡à¸™à¸µà¹‰ à¹ƒà¸«à¹‰à¸–à¸·à¸­à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ Summary à¹à¸¥à¸°à¸ˆà¸°à¹„à¸¡à¹ˆà¹€à¸­à¸²à¹„à¸›à¸›à¸™à¸à¸±à¸šà¹€à¸à¸“à¸‘à¹Œ SE-AM
    summary_signals = [
        "à¸ªà¸£à¸¸à¸›", "à¸ à¸²à¸à¸£à¸§à¸¡", "à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”", "executive summary", "overview", "à¸ªà¸²à¸£à¸°à¸ªà¸³à¸„à¸±à¸", "key points",
        "summary", "summarize", "summarise", "comprehensive summary", 
        "provide a summary", "give me a summary", "summarize all", "summary of all"
    ]
    if any(sig in q for sig in summary_signals):
        intent["is_summary"] = True
        # à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸ªà¸à¸±à¸” sub_topic à¹€à¸à¸·à¹ˆà¸­à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ Router à¸«à¸¥à¸‡à¸—à¸²à¸‡à¹„à¸›à¸«à¸² Engine à¸›à¸£à¸°à¹€à¸¡à¸´à¸™
        return intent

    # --- 2. à¸ªà¸à¸±à¸” Enabler/Sub-topic (à¸ªà¸³à¸«à¸£à¸±à¸šà¹‚à¸«à¸¡à¸”à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸›à¸à¸•à¸´) ---
    enabler_pattern = "|".join([e.lower() for e in SUPPORTED_ENABLERS])
    match = re.search(rf"(?:^|\s)({enabler_pattern})\s*[:\-]?\s*(\d+\.\d+)|(\d+\.\d+)", q)
    
    if match:
        found_enabler = (match.group(1) or "").upper()
        intent["enabler_hint"] = found_enabler if found_enabler in SUPPORTED_ENABLERS else None
        intent["sub_topic"] = match.group(2) or match.group(3)
    
    if not intent["sub_topic"] and user_context:
        for msg in reversed(user_context):
            text = msg.get("content", "").lower()
            m = re.search(rf"(?:^|\s)({enabler_pattern})\s*[:\-]?\s*(\d+\.\d+)|(\d+\.\d+)", text)
            if m:
                found_enabler = (m.group(1) or "").upper()
                intent["enabler_hint"] = found_enabler if found_enabler in SUPPORTED_ENABLERS else None
                intent["sub_topic"] = m.group(2) or m.group(3)
                break

    # --- 3. Greeting Intent ---
    greeting_signals = ["à¸ªà¸§à¸±à¸ªà¸”à¸µ", "à¸”à¸µà¸„à¸£à¸±à¸š", "à¸”à¸µà¸„à¹ˆà¸°", "hello", "hi", "hey"]
    if any(sig in q for sig in greeting_signals):
        intent["is_greeting"] = True
        return intent

    # --- 4. Capabilities ---
    capabilities_signals = ["à¸—à¸³à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡", "à¸Šà¹ˆà¸§à¸¢à¸­à¸°à¹„à¸£à¹„à¸”à¹‰", "capabilities", "features"]
    if any(sig in q for sig in capabilities_signals):
        intent["is_capabilities"] = True
        return intent

    # --- 5. Comparison Intent ---
    comparison_signals = ["à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸š", "à¸„à¸§à¸²à¸¡à¹à¸•à¸à¸•à¹ˆà¸²à¸‡", "à¸•à¹ˆà¸²à¸‡à¸ˆà¸²à¸", "vs", "compare"]
    if any(sig in q for sig in comparison_signals):
        intent["is_comparison"] = True
        return intent

    # --- 6. SE-AM Criteria / Analysis Intent ---
    # à¸–à¹‰à¸²à¸¡à¸µà¸„à¸³à¸—à¸µà¹ˆà¸šà¹ˆà¸‡à¸šà¸­à¸à¸–à¸¶à¸‡à¸à¸²à¸£à¸›à¸£à¸°à¹€à¸¡à¸´à¸™ à¸«à¸£à¸·à¸­à¸¡à¸µà¸£à¸«à¸±à¸ªà¹€à¸à¸“à¸‘à¹Œ (sub_topic) à¸•à¸´à¸”à¸¡à¸² à¹ƒà¸«à¹‰à¹€à¸‚à¹‰à¸²à¹‚à¸«à¸¡à¸” Analysis
    criteria_signals = [
        "à¸œà¹ˆà¸²à¸™à¹€à¸à¸“à¸‘à¹Œ", "sub criteria", "à¸œà¹ˆà¸²à¸™ level", "à¸ªà¸™à¸±à¸šà¸ªà¸™à¸¸à¸™à¹€à¸à¸“à¸‘à¹Œ", "criteria",
        "comply", "compliance", "à¸•à¸²à¸¡à¹€à¸à¸“à¸‘à¹Œ", "à¸ªà¸­à¸”à¸„à¸¥à¹‰à¸­à¸‡", "à¸‚à¹‰à¸­à¸à¸³à¸«à¸™à¸”", "à¹à¸™à¸°à¸™à¸³à¸«à¸™à¹ˆà¸­à¸¢", 
        "à¸„à¸§à¸£à¸—à¸³à¸¢à¸±à¸‡à¹„à¸‡", "à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸¢à¸±à¸‡à¹„à¸‡", "à¸Šà¹ˆà¸§à¸¢à¹€à¸‚à¸µà¸¢à¸™à¸«à¸™à¹ˆà¸­à¸¢", "à¸£à¹ˆà¸²à¸‡à¹€à¸™à¸·à¹‰à¸­à¸«à¸²" 
    ]
    if any(sig in q for sig in criteria_signals) or intent["sub_topic"]:
        intent["is_analysis"] = True
        intent["is_criteria_query"] = True if any(sig in q for sig in criteria_signals) else False
        return intent
    
    # --- 7. PDCA / Deep Analysis ---
    analysis_keywords = set(PDCA_ANALYSIS_SIGNALS or [])
    analysis_keywords.update(["pdca", "plan", "do", "check", "act", "à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ", "à¸›à¸£à¸°à¹€à¸¡à¸´à¸™", "gap"])
    if any(sig in q for sig in analysis_keywords):
        intent["is_analysis"] = True
        return intent

    # --- 8. Default: FAQ ---
    if any(sig in q for sig in ["à¸„à¸·à¸­à¸­à¸°à¹„à¸£", "à¸„à¸·à¸­", "à¸«à¸¡à¸²à¸¢à¸–à¸¶à¸‡"]):
        intent["is_faq"] = True

    return intent


# ======================================================================
# Prompt Guardrails Builder (Conversation-aware + Intent-specific)
# ======================================================================

def build_prompt(
    context: str,
    question: str,
    intent: Dict[str, Any],
    user_context: Optional[List[Dict[str, Any]]] = None
) -> str:
    """
    à¸ªà¸£à¹‰à¸²à¸‡ system-style instruction à¹à¸šà¸š dynamic à¸•à¸²à¸¡ intent à¹à¸¥à¸°à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²
    à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¹à¸à¹‰à¹„à¸‚: à¹à¸¢à¸ Summary à¸­à¸­à¸à¸ˆà¸²à¸ Analysis à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸”à¹‡à¸”à¸‚à¸²à¸”
    """
    sections = []

    # 1. à¸à¸à¸à¸·à¹‰à¸™à¸à¸²à¸™à¹à¸¥à¸°à¸à¸²à¸£à¸šà¸±à¸‡à¸„à¸±à¸šà¸ à¸²à¸©à¸²
    sections.append("### à¸à¸à¹€à¸«à¸¥à¹‡à¸: à¸•à¸­à¸šà¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ (à¸¢à¸à¹€à¸§à¹‰à¸™à¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œà¸«à¸£à¸·à¸­à¸„à¸³à¹€à¸—à¸„à¸™à¸´à¸„à¹ƒà¸™à¹€à¸­à¸à¸ªà¸²à¸£) ###")

    # 2. à¸à¸³à¸«à¸™à¸”à¸šà¸—à¸šà¸²à¸— (Role) à¸•à¸²à¸¡ Intent
    # Priority: Summary > Comparison > Analysis
    if intent.get("is_summary"):
        role = "à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™à¸à¸²à¸£à¸ªà¸£à¸¸à¸›à¸ªà¸²à¸£à¸°à¸ªà¸³à¸„à¸±à¸à¹€à¸Šà¸´à¸‡à¸œà¸¹à¹‰à¸šà¸£à¸´à¸«à¸²à¸£ (Executive Summary)"
        sections.append("### MODE: SUMMARY ONLY ###")
        sections.append("à¸„à¸³à¹€à¸•à¸·à¸­à¸™: à¸«à¹‰à¸²à¸¡à¸—à¸³à¸à¸²à¸£à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸„à¸°à¹à¸™à¸™ à¸«à¸£à¸·à¸­à¹ƒà¸Šà¹‰à¹€à¸à¸“à¸‘à¹Œ SE-AM/PDCA à¹ƒà¸™à¸„à¸³à¸•à¸­à¸šà¸™à¸µà¹‰à¹€à¸”à¹‡à¸”à¸‚à¸²à¸” à¹ƒà¸«à¹‰à¸ªà¸£à¸¸à¸›à¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¸ˆà¸²à¸à¹€à¸­à¸à¸ªà¸²à¸£à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™")
    elif intent.get("is_comparison"):
        role = "à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™à¸à¸²à¸£à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¹€à¸­à¸à¸ªà¸²à¸£à¹à¸¥à¸°à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸„à¸§à¸²à¸¡à¹à¸•à¸à¸•à¹ˆà¸²à¸‡à¹€à¸Šà¸´à¸‡à¸™à¹‚à¸¢à¸šà¸²à¸¢"
    elif intent.get("is_analysis") or intent.get("is_criteria_query"):
        role = f"à¸œà¸¹à¹‰à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸„à¸¸à¸“à¸ à¸²à¸à¸«à¸¥à¸±à¸à¸à¸²à¸™à¸•à¸²à¸¡à¸à¸£à¸­à¸š {ANALYSIS_FRAMEWORK} à¹à¸¥à¸°à¹€à¸à¸“à¸‘à¹Œ SE-AM"
    else:
        role = "à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™à¸­à¸‡à¸„à¹Œà¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¹à¸¥à¸°à¹€à¸­à¸à¸ªà¸²à¸£à¸­à¸‡à¸„à¹Œà¸à¸£"

    sections.append(f"à¸šà¸—à¸šà¸²à¸—à¸‚à¸­à¸‡à¸„à¸¸à¸“: {role}")

    # 3. à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸ˆà¸²à¸à¸„à¸¥à¸±à¸‡à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰ (RAG Context)
    sections.append("--- à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸ˆà¸²à¸à¸£à¸°à¸šà¸šà¸„à¸¥à¸±à¸‡à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰ ---")
    sections.append(context)
    sections.append("-----------------------------------")

    # 4. à¸šà¸£à¸´à¸šà¸—à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸² (History)
    if user_context:
        snapshot = "\n".join([f"- {m.get('content')}" for m in user_context[-6:]])
        sections.append("### à¸šà¸£à¸´à¸šà¸—à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²:")
        sections.append(snapshot)

    # 5. à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
    sections.append(f"### à¸„à¸³à¸–à¸²à¸¡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰: {question}")

    # 6. à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¹€à¸‰à¸à¸²à¸° (Detailed Instructions) à¸•à¸²à¸¡ Intent
    if intent.get("is_summary"):
        sections.append(
            "à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸ªà¸£à¸¸à¸›:\n"
            "1. à¸ªà¸£à¸¸à¸›à¹€à¸­à¸à¸ªà¸²à¸£à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸à¸­à¸¢à¹ˆà¸²à¸‡à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸š Executive Summary\n"
            "2. à¸«à¹‰à¸²à¸¡à¸à¸¹à¸”à¸–à¸¶à¸‡ 'à¹€à¸à¸“à¸‘à¹Œ', 'à¸„à¸°à¹à¸™à¸™', à¸«à¸£à¸·à¸­ 'à¸à¸²à¸£à¸œà¹ˆà¸²à¸™à¸£à¸°à¸”à¸±à¸š Level' à¹ƒà¸”à¹† à¸—à¸±à¹‰à¸‡à¸ªà¸´à¹‰à¸™\n"
            "3. à¸«à¹‰à¸²à¸¡à¹ƒà¸Šà¹‰à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸²à¸£à¸²à¸‡ PDCA\n"
            "4. à¸«à¹‰à¸²à¸¡à¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©à¹ƒà¸™à¸à¸²à¸£à¹€à¸¥à¹ˆà¸²à¹€à¸£à¸·à¹ˆà¸­à¸‡ (Narrative) à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰à¸à¸²à¸£à¸—à¸±à¸šà¸¨à¸±à¸à¸—à¹Œà¹€à¸‰à¸à¸²à¸°à¸„à¸³à¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™\n\n"
            "à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸£à¸¹à¸›à¹à¸šà¸šà¸à¸²à¸£à¸•à¸­à¸š:\n"
            "**à¸šà¸—à¸ªà¸£à¸¸à¸›à¸œà¸¹à¹‰à¸šà¸£à¸´à¸«à¸²à¸£**\n"
            "- **à¸«à¸±à¸§à¸‚à¹‰à¸­à¸«à¸¥à¸±à¸:** [à¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸ˆà¸²à¸à¹€à¸­à¸à¸ªà¸²à¸£]\n"
            "- **à¸ªà¸²à¸£à¸°à¸ªà¸³à¸„à¸±à¸:** [à¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¹‚à¸”à¸¢à¸ªà¸£à¸¸à¸›...]\n"
            "- **à¸›à¸£à¸°à¹€à¸”à¹‡à¸™à¸ªà¸³à¸„à¸±à¸:** [1..., 2...]\n"
            "- **à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡:** [à¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œ à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆ...]\n"
        )
    elif intent.get("is_comparison"):
        sections.append(
            "à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸š:\n"
            "- à¸£à¸°à¸šà¸¸à¸ˆà¸¸à¸”à¹€à¸«à¸¡à¸·à¸­à¸™à¹à¸¥à¸°à¸ˆà¸¸à¸”à¸•à¹ˆà¸²à¸‡à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¹€à¸­à¸à¸ªà¸²à¸£à¹à¸•à¹ˆà¸¥à¸°à¸‰à¸šà¸±à¸š\n"
            "- à¸™à¸³à¹€à¸ªà¸™à¸­à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸šà¸•à¸²à¸£à¸²à¸‡ Markdown\n"
            "- à¸«à¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸›à¸£à¸²à¸à¸à¹ƒà¸™à¸šà¸²à¸‡à¹€à¸­à¸à¸ªà¸²à¸£ à¹ƒà¸«à¹‰à¸£à¸°à¸šà¸¸ 'à¹„à¸¡à¹ˆà¸›à¸£à¸²à¸à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥'"
        )
    elif intent.get("is_analysis") or intent.get("is_criteria_query"):
        sections.append(
            f"à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ (à¸à¸£à¸­à¸š {ANALYSIS_FRAMEWORK}):\n"
            "1. à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸„à¸¸à¸“à¸ à¸²à¸à¸‚à¸­à¸‡à¸«à¸¥à¸±à¸à¸à¸²à¸™à¸•à¸²à¸¡à¹€à¸à¸“à¸‘à¹Œ SE-AM\n"
            "2. à¸£à¸°à¸šà¸¸à¸ˆà¸¸à¸”à¹à¸‚à¹‡à¸‡ (Strengths) à¹à¸¥à¸°à¸Šà¹ˆà¸­à¸‡à¸§à¹ˆà¸²à¸‡ (Gaps) à¸•à¸²à¸¡à¸à¸£à¸­à¸š PDCA\n"
            "3. à¸£à¸°à¸šà¸¸à¸£à¸°à¸”à¸±à¸š Maturity Level (L1-L5) à¸—à¸µà¹ˆà¸ªà¸­à¸”à¸„à¸¥à¹‰à¸­à¸‡à¸à¸±à¸šà¸«à¸¥à¸±à¸à¸à¸²à¸™"
        )
    else:
        sections.append(
            "à¸„à¸³à¸ªà¸±à¹ˆà¸‡: à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸›à¸£à¸°à¹€à¸”à¹‡à¸™à¹‚à¸”à¸¢à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸ˆà¸²à¸à¹€à¸­à¸à¸ªà¸²à¸£à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸—à¸µà¹ˆà¹ƒà¸«à¹‰à¸¡à¸²à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ "
            "à¸«à¸²à¸à¹„à¸¡à¹ˆà¸à¸šà¸„à¸³à¸•à¸­à¸šà¹ƒà¸™à¹€à¸­à¸à¸ªà¸²à¸£ à¹ƒà¸«à¹‰à¹à¸ˆà¹‰à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸•à¸²à¸¡à¸•à¸£à¸‡à¸§à¹ˆà¸²à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥"
        )

    # 7. à¸à¸à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸² (à¸›à¸´à¸”à¸—à¹‰à¸²à¸¢à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰ Model à¹ƒà¸«à¹‰à¸„à¸§à¸²à¸¡à¸ªà¸³à¸„à¸±à¸à¸ªà¸¹à¸‡à¸ªà¸¸à¸”)
    sections.append(
        "### à¸à¸à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡ ###\n"
        "1. à¸šà¸£à¸£à¸¢à¸²à¸¢à¸ªà¸£à¸¸à¸›à¹à¸¥à¸°à¹€à¸¥à¹ˆà¸²à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸”à¹‰à¸§à¸¢à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¸—à¸µà¹ˆà¸ªà¸¥à¸°à¸ªà¸¥à¸§à¸¢\n"
        "2. à¸„à¸‡à¸Šà¸·à¹ˆà¸­à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©à¸‚à¸­à¸‡à¹‚à¸„à¸£à¸‡à¸à¸²à¸£, à¸£à¸«à¸±à¸ªà¹€à¸­à¸à¸ªà¸²à¸£, à¸«à¸£à¸·à¸­à¸Šà¸·à¹ˆà¸­à¹€à¸‰à¸à¸²à¸°à¹„à¸§à¹‰à¸•à¸²à¸¡à¸•à¹‰à¸™à¸‰à¸šà¸±à¸š\n"
        "3. à¸«à¸²à¸à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸–à¸²à¸¡à¸¡à¸²à¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© à¹ƒà¸«à¹‰à¸—à¸³à¸à¸²à¸£à¸ªà¸£à¸¸à¸›à¹à¸¥à¸°à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¹€à¸›à¹‡à¸™ 'à¸ à¸²à¸©à¸²à¹„à¸—à¸¢' à¹€à¸ªà¸¡à¸­"
    )

    return "\n\n".join(sections)


# ======================================================================
# Post-response Validation (Enhanced Thai Safety Net)
# ======================================================================

def enforce_thai_primary_language(response_text: str) -> str:
    """
    Revised Version: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸¥à¸°à¸šà¸±à¸‡à¸„à¸±à¸šà¸—à¸´à¸¨à¸—à¸²à¸‡à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¹à¸šà¸šà¹€à¸‚à¹‰à¸¡à¸‡à¸§à¸”
    """
    if not response_text or not response_text.strip():
        return response_text

    # 1. à¸¥à¹‰à¸²à¸‡à¸šà¸£à¸£à¸—à¸±à¸”à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¹€à¸™à¸·à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸à¸·à¹ˆà¸­à¸•à¸£à¸§à¸ˆà¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸ à¸²à¸©à¸²
    lines = [line.strip() for line in response_text.splitlines() if line.strip()]
    narrative_lines = []
    for line in lines:
        if any(line.startswith(p) for p in ["#", "|", "-", "*", ">", "```", "["]):
            continue
        if len(line.split()) <= 3: # à¸‚à¹‰à¸²à¸¡à¸à¸§à¸à¸Šà¸·à¹ˆà¸­à¸«à¸±à¸§à¸‚à¹‰à¸­à¸ªà¸±à¹‰à¸™à¹†
            continue
        narrative_lines.append(line)

    if not narrative_lines:
        return response_text

    narrative_text = " ".join(narrative_lines)
    
    # 2. à¸™à¸±à¸šà¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£à¹„à¸—à¸¢
    thai_count = len(re.findall(r"[à¸-à¹™]", narrative_text))
    # à¸™à¸±à¸šà¸„à¸³à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© (à¸—à¸µà¹ˆà¸¡à¸µà¸„à¸§à¸²à¸¡à¸¢à¸²à¸§ > 2 à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£)
    eng_words = re.findall(r"\b[a-zA-Z]{3,}\b", narrative_text)

    # ğŸ¯ à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸­à¸²à¸à¸²à¸£à¸”à¸·à¹‰à¸­ (Stubbornness Detection)
    # à¸–à¹‰à¸²à¸„à¸³à¸­à¸±à¸‡à¸à¸¤à¸©à¹€à¸¢à¸­à¸°à¸à¸§à¹ˆà¸²à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£à¹„à¸—à¸¢ (à¸‹à¸¶à¹ˆà¸‡à¸›à¸à¸•à¸´ 1 à¸„à¸³à¹„à¸—à¸¢à¸¡à¸µà¸«à¸¥à¸²à¸¢à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£) à¹à¸ªà¸”à¸‡à¸§à¹ˆà¸²à¸”à¸·à¹‰à¸­à¹à¸™à¹ˆà¸™à¸­à¸™
    if len(eng_words) > 10 and thai_count < 20:
        logger.error(f"ğŸš¨ AI à¸”à¸·à¹‰à¸­à¸•à¸­à¸šà¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©à¸¥à¹‰à¸§à¸™! (ENG Words: {len(eng_words)}, Thai Chars: {thai_count})")
        
        # à¸¢à¸²à¹à¸£à¸‡: à¸šà¸±à¸‡à¸„à¸±à¸šà¹à¸—à¸£à¸à¸„à¸³à¹€à¸•à¸·à¸­à¸™ à¹à¸¥à¸°à¸ªà¸£à¸¸à¸›à¸ªà¸±à¹‰à¸™à¹† (à¸–à¹‰à¸²à¸—à¸³à¹„à¸”à¹‰)
        stubborn_msg = (
            "âš ï¸ **[à¸£à¸°à¸šà¸šà¸•à¸£à¸§à¸ˆà¸à¸šà¸§à¹ˆà¸² AI à¸•à¸­à¸šà¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©]**\n"
            "*à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸šà¸±à¸‡à¸„à¸±à¸šà¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¸–à¸¹à¸à¸¥à¸°à¹€à¸¥à¸¢à¹‚à¸”à¸¢ Model à¹‚à¸›à¸£à¸”à¸¥à¸­à¸‡à¸–à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆà¸”à¹‰à¸§à¸¢à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ à¸«à¸£à¸·à¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š System Prompt*\n\n"
            "---\n"
        )
        return stubborn_msg + response_text

    return response_text