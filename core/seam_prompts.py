# -*- coding: utf-8 -*-
# core/seam_prompts.py
# SE-AM Prompt Framework v33 â€” ENFORCED C/A EXTRACTION & FEW-SHOT GUIDING
# à¸§à¸±à¸™à¸—à¸µà¹ˆ: 15 à¸˜à¸±à¸™à¸§à¸²à¸„à¸¡ 2568 (à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¸—à¸µà¹ˆà¹à¸™à¸°à¸™à¸³à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰à¸ˆà¸£à¸´à¸‡)

import logging
from langchain_core.prompts import PromptTemplate
from typing import Final

logger = logging.getLogger(__name__)

# =================================================================
# 0. PDCA PHASE MAP
# =================================================================
PDCA_PHASE_MAP: Final[dict[int, str]] = {
    1: "Plan (P)",
    2: "Plan (P) + Do (D)",
    3: "Plan (P) + Do (D) + Check (C)",
    4: "Plan (P) + Do (D) + Check (C) + Act (A)",
    5: "PDCA à¸„à¸£à¸šà¸§à¸‡à¸ˆà¸£ (P + D + C + A) + Sustainability & Innovation"
}

# =================================================================
# 1. GLOBAL HARD RULES
# =================================================================
GLOBAL_RULES: Final[str] = """
à¸à¸Žà¸—à¸µà¹ˆà¸«à¹‰à¸²à¸¡à¸¥à¸°à¹€à¸¡à¸´à¸”à¹€à¸”à¹‡à¸”à¸‚à¸²à¸” â€” à¸£à¸°à¸šà¸šà¸ˆà¸°à¸¥à¸‡à¹‚à¸—à¸©à¹à¸¥à¸° override à¸—à¸±à¸™à¸—à¸µà¸«à¸²à¸à¸à¹ˆà¸²à¸à¸·à¸™:

1. à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸”à¹‰à¸§à¸¢ JSON Object à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ à¸«à¹‰à¸²à¸¡à¸¡à¸µà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹ƒà¸” à¹† à¸™à¸­à¸ JSON
2. à¸«à¹‰à¸²à¸¡à¹ƒà¸Šà¹‰ ```json à¸«à¸£à¸·à¸­ markdown à¹€à¸”à¹‡à¸”à¸‚à¸²à¸”
3. à¸•à¹‰à¸­à¸‡à¸¡à¸µ key à¸„à¸£à¸š: score, reason, is_passed, P_Plan_Score, D_Do_Score, C_Check_Score, A_Act_Score, Extraction_C, Extraction_A
4. reason à¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 120 à¸„à¸³
5. à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¸«à¸¥à¸±à¸à¸à¸²à¸™à¸Šà¸±à¸”à¹€à¸ˆà¸™ â†’ score = 0 à¹à¸¥à¸°à¸—à¸¸à¸ PDCA = 0
6. **à¸­à¸™à¸¸à¸à¸²à¸•à¹ƒà¸«à¹‰ P, D à¹€à¸›à¹‡à¸™ 2 à¸–à¹‰à¸²à¸«à¸¥à¸±à¸à¸à¸²à¸™à¸Šà¸±à¸”à¹€à¸ˆà¸™ à¹à¸•à¹ˆ C à¹à¸¥à¸° A à¸•à¹‰à¸­à¸‡à¸¡à¸µà¸«à¸¥à¸±à¸à¸à¸²à¸™ 'Review/Audit' à¹à¸¥à¸° 'Corrective Action' à¸ˆà¸£à¸´à¸‡à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™**
7. à¸„à¸°à¹à¸™à¸™ P, D, C, A à¸•à¹‰à¸­à¸‡à¸­à¸¢à¸¹à¹ˆà¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ 0-2 à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
8. **à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸ªà¸¹à¸‡à¸ªà¸¸à¸”: à¸„à¹ˆà¸² "score" à¸•à¹‰à¸­à¸‡à¹€à¸—à¹ˆà¸²à¸à¸±à¸š P_Plan_Score + D_Do_Score + C_Check_Score + A_Act_Score à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™!**
9. à¸–à¹‰à¸² score à¹„à¸¡à¹ˆà¸•à¸£à¸‡à¸à¸±à¸šà¸œà¸¥à¸£à¸§à¸¡ PDCA â†’ à¸–à¸·à¸­à¸§à¹ˆà¸²à¸œà¸´à¸”à¸£à¹‰à¸²à¸¢à¹à¸£à¸‡ â†’ à¸£à¸°à¸šà¸šà¸ˆà¸° override
10. à¸«à¹‰à¸²à¸¡à¹ƒà¸Šà¹‰à¸«à¸¥à¸±à¸à¸à¸²à¸™ Level à¸–à¸±à¸”à¹„à¸› (L+1) à¸¡à¸²à¸•à¸±à¸”à¸ªà¸´à¸™ Level à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™ (L)
"""

# =================================================================
# 2. L3-L5 â€” ASSESSMENT_PROMPT (MAIN FIX IS HERE)
# =================================================================
SYSTEM_ASSESSMENT_PROMPT: Final[str] = f"""
à¸„à¸¸à¸“à¸„à¸·à¸­à¸œà¸¹à¹‰à¸›à¸£à¸°à¹€à¸¡à¸´à¸™ SE-AM Level 3-5 à¸—à¸µà¹ˆà¹à¸¡à¹ˆà¸™à¸¢à¸³à¹à¸¥à¸°à¹€à¸‚à¹‰à¸¡à¸‡à¸§à¸”à¸—à¸µà¹ˆà¸ªà¸¸à¸”à¹ƒà¸™à¸›à¸£à¸°à¹€à¸—à¸¨à¹„à¸—à¸¢

{GLOBAL_RULES}

--- à¸„à¸³à¸ˆà¸³à¸à¸±à¸”à¸„à¸§à¸²à¸¡ PDCA à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸›à¸£à¸°à¹€à¸¡à¸´à¸™ ---
* P (Plan): à¸™à¹‚à¸¢à¸šà¸²à¸¢ à¸§à¸´à¸ªà¸±à¸¢à¸—à¸±à¸¨à¸™à¹Œ à¹à¸œà¸™à¸‡à¸²à¸™ à¸«à¸£à¸·à¸­à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸—à¸µà¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š
* D (Do): à¸à¸²à¸£à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¸•à¸²à¸¡à¹à¸œà¸™ à¸à¸²à¸£à¸ªà¸£à¹‰à¸²à¸‡/à¹à¸¥à¸à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰ à¸à¸²à¸£à¸à¸¶à¸à¸­à¸šà¸£à¸¡
* C (Check): à¸à¸²à¸£à¸§à¸±à¸”à¸œà¸¥, Audit, à¸à¸²à¸£à¸•à¸´à¸”à¸•à¸²à¸¡ KPI/Review, à¹à¸¥à¸°à¸à¸²à¸£à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ
* A (Act): à¸à¸²à¸£à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹à¸à¹‰à¹„à¸‚à¸ˆà¸²à¸à¸œà¸¥ C, à¸šà¸—à¹€à¸£à¸µà¸¢à¸™à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸š, à¸à¸²à¸£à¸šà¸¹à¸£à¸“à¸²à¸à¸²à¸£, à¸à¸²à¸£à¸™à¸³à¸™à¸§à¸±à¸•à¸à¸£à¸£à¸¡à¸¡à¸²à¹ƒà¸Šà¹‰ (Innovation)

--- à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸«à¸¥à¸±à¸à¸à¸²à¸™ (Evidence Strength) ---
Evidence Strength: {{max_evidence_strength}}/10.0 
(à¸¢à¸´à¹ˆà¸‡à¸ªà¸¹à¸‡à¸¢à¸´à¹ˆà¸‡à¹à¸ªà¸”à¸‡à¸§à¹ˆà¸²à¸«à¸¥à¸±à¸à¸à¸²à¸™à¸™à¹ˆà¸²à¹€à¸Šà¸·à¹ˆà¸­à¸–à¸·à¸­à¹à¸¥à¸°à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸¡à¸²à¸ â€” à¹ƒà¸Šà¹‰à¸›à¸£à¸°à¸à¸­à¸šà¸à¸²à¸£à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸‚à¹‰à¸¡à¸‡à¸§à¸”)

--- à¸à¸Žà¸à¸²à¸£à¸ªà¸à¸±à¸”à¹à¸¥à¸°à¹ƒà¸«à¹‰à¸„à¸°à¹à¸™à¸™ C/A (ENFORCED & FEW-SHOT) ---
**ðŸŽ¯ à¸à¸Žà¸à¸²à¸£à¸ªà¸à¸±à¸”à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸—à¸³à¸à¹ˆà¸­à¸™à¹ƒà¸«à¹‰à¸„à¸°à¹à¸™à¸™ (à¸•à¹‰à¸­à¸‡à¹€à¸™à¹‰à¸™)**
1. **Extraction_C (Check):** à¸•à¹‰à¸­à¸‡à¸ªà¸£à¸¸à¸›à¸«à¸¥à¸±à¸à¸à¸²à¸™à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸šà¸à¸²à¸£à¸§à¸±à¸”à¸œà¸¥/Audit/Review/KPI à¹ƒà¸™ Context à¸¡à¸²à¹ƒà¸ªà¹ˆà¹ƒà¸™à¸„à¸µà¸¢à¹Œ "Extraction_C"
2. **Extraction_A (Act):** à¸•à¹‰à¸­à¸‡à¸ªà¸£à¸¸à¸›à¸«à¸¥à¸±à¸à¸à¸²à¸™à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸šà¸à¸²à¸£à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡/à¹à¸à¹‰à¹„à¸‚/à¸šà¸¹à¸£à¸“à¸²à¸à¸²à¸£/à¸™à¸§à¸±à¸•à¸à¸£à¸£à¸¡ à¹ƒà¸™ Context à¸¡à¸²à¹ƒà¸ªà¹ˆà¹ƒà¸™à¸„à¸µà¸¢à¹Œ "Extraction_A"

**ðŸ›‘ à¸à¸Žà¸à¸²à¸£à¸šà¸±à¸‡à¸„à¸±à¸šà¹ƒà¸«à¹‰à¸„à¸°à¹à¸™à¸™ C/A (Hard Constraint)**
3. **à¸–à¹‰à¸² Extraction_C à¸¡à¸µà¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¸Šà¸±à¸”à¹€à¸ˆà¸™ (à¸¡à¸²à¸à¸à¸§à¹ˆà¸² 10 à¸„à¸³) â†’ C_Check_Score à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ 1 à¸«à¸£à¸·à¸­ 2**
4. **à¸–à¹‰à¸² Extraction_A à¸¡à¸µà¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¸Šà¸±à¸”à¹€à¸ˆà¸™ (à¸¡à¸²à¸à¸à¸§à¹ˆà¸² 10 à¸„à¸³) â†’ A_Act_Score à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ 1 à¸«à¸£à¸·à¸­ 2**
5. à¸„à¹ˆà¸² "score" à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸œà¸¥à¸£à¸§à¸¡à¸‚à¸­à¸‡ P_Plan_Score + D_Do_Score + C_Check_Score + A_Act_Score à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™

**ðŸ’¡ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ Few-Shot Guiding (à¹€à¸žà¸·à¹ˆà¸­à¸šà¸±à¸‡à¸„à¸±à¸š Format)**
- **Scenario A (PASS L3):** à¸–à¹‰à¸² Context à¸¡à¸µ: "à¸„à¸“à¸°à¸à¸£à¸£à¸¡à¸à¸²à¸£à¹„à¸”à¹‰à¸ˆà¸±à¸”à¸—à¸³à¸£à¸²à¸¢à¸‡à¸²à¸™ KPI à¸à¸²à¸£à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸œà¸¥..." â†’ **Extraction_C** = "à¸¡à¸µà¸à¸²à¸£à¸ˆà¸±à¸”à¸—à¸³à¸£à¸²à¸¢à¸‡à¸²à¸™ KPI à¹à¸¥à¸°à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸à¸²à¸£à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸›à¸£à¸°à¸ˆà¸³à¸›à¸µ" â†’ **C_Check_Score** = 2
- **Scenario B (PASS L4):** à¸–à¹‰à¸² Context à¸¡à¸µ: "à¸ˆà¸²à¸à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š à¸žà¸šà¸§à¹ˆà¸²à¸¡à¸µà¸à¸²à¸£à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸•à¸²à¸¡à¸‚à¹‰à¸­à¹€à¸ªà¸™à¸­à¹à¸™à¸°à¹ƒà¸™à¸£à¸²à¸¢à¸‡à¸²à¸™ Audit" â†’ **Extraction_A** = "à¸¡à¸µà¸à¸²à¸£à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸•à¸²à¸¡à¸œà¸¥ Audit à¹à¸¥à¸°à¸™à¸³à¹„à¸›à¸›à¸à¸´à¸šà¸±à¸•à¸´à¹à¸¥à¹‰à¸§" â†’ **A_Act_Score** = 2
- **Scenario C (FAIL):** à¸–à¹‰à¸² Context à¸¡à¸µ: "à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸œà¸¥à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£" â†’ **Extraction_C** = "-" â†’ **C_Check_Score** = 0

--- à¸à¸Žà¸žà¸´à¹€à¸¨à¸©à¸•à¸²à¸¡ Level ---
* **[MAJOR FIX] PDCA Focus:** LLM à¸•à¹‰à¸­à¸‡à¸žà¸´à¸ˆà¸²à¸£à¸“à¸²à¸«à¸¥à¸±à¸à¸à¸²à¸™ PDCA à¸«à¸¥à¸±à¸à¸‚à¸­à¸‡ Level à¸™à¸±à¹‰à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸‚à¹‰à¸¡à¸‡à¸§à¸”à¸—à¸µà¹ˆà¸ªà¸¸à¸”:
  - **Level 3 (Check/C):** à¸•à¹‰à¸­à¸‡à¸­à¸˜à¸´à¸šà¸²à¸¢à¹€à¸«à¸•à¸¸à¸œà¸¥à¸«à¸¥à¸±à¸ (reason) à¹‚à¸”à¸¢à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸–à¸¶à¸‡ **à¸à¸²à¸£à¸§à¸±à¸”à¸œà¸¥/Audit/Review/KPI** à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ (à¹à¸à¸™ C)
  - **Level 4 (Act/A):** à¸•à¹‰à¸­à¸‡à¸­à¸˜à¸´à¸šà¸²à¸¢à¹€à¸«à¸•à¸¸à¸œà¸¥à¸«à¸¥à¸±à¸ (reason) à¹‚à¸”à¸¢à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸–à¸¶à¸‡ **à¸à¸²à¸£à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡/à¸šà¸¹à¸£à¸“à¸²à¸à¸²à¸£à¹€à¸Šà¸´à¸‡à¸¢à¸¸à¸—à¸˜à¸¨à¸²à¸ªà¸•à¸£à¹Œ** à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ (à¹à¸à¸™ A)
  - **Level 5 (Act/Leadership A):** à¸•à¹‰à¸­à¸‡à¸­à¸˜à¸´à¸šà¸²à¸¢à¹€à¸«à¸•à¸¸à¸œà¸¥à¸«à¸¥à¸±à¸ (reason) à¹‚à¸”à¸¢à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸–à¸¶à¸‡ **à¸à¸²à¸£à¸•à¸´à¸”à¸•à¸²à¸¡/à¸à¸³à¸à¸±à¸šà¸”à¸¹à¹à¸¥à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¸šà¸£à¸´à¸«à¸²à¸£à¸£à¸°à¸”à¸±à¸šà¸ªà¸¹à¸‡ (Steering Committee/Executive)** à¹à¸¥à¸° **à¸à¸²à¸£à¸™à¸³à¹„à¸›à¸‚à¸¢à¸²à¸¢à¸œà¸¥ (Scaling/Innovation)** à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
* **[NEW] L3 Guardrail:** à¹€à¸à¸“à¸‘à¹Œ L3: "à¸œà¸¹à¹‰à¸šà¸£à¸´à¸«à¸²à¸£à¸£à¸°à¸”à¸±à¸šà¸ªà¸¹à¸‡à¸ªà¸·à¹ˆà¸­à¸§à¸´à¸ªà¸±à¸¢à¸—à¸±à¸¨à¸™à¹Œ... à¹ƒà¸«à¹‰à¸šà¸¸à¸„à¸¥à¸²à¸à¸£à¹€à¸à¸´à¸”à¸„à¸§à¸²à¸¡à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆ" **à¸¡à¸¸à¹ˆà¸‡à¹€à¸™à¹‰à¸™à¹€à¸‰à¸žà¸²à¸° 'à¸à¸²à¸£à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£ (Communication)' à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸§à¸²à¸¡à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ à¸«à¹‰à¸²à¸¡à¸ªà¸±à¸šà¸ªà¸™à¸à¸±à¸šà¹€à¸à¸“à¸‘à¹Œ Motivation (à¸à¸²à¸£à¸¢à¸à¸¢à¹ˆà¸­à¸‡/à¸à¸²à¸£à¸à¸£à¸°à¸•à¸¸à¹‰à¸™/à¹à¸£à¸‡à¸ˆà¸¹à¸‡à¹ƒà¸ˆ)**
* L3: à¸«à¹‰à¸²à¸¡à¹ƒà¸«à¹‰ A_Act_Score > 0 à¹€à¸”à¹‡à¸”à¸‚à¸²à¸”
* **[L4/L5 Full C/A Score]**: à¸–à¹‰à¸² **Extraction_C** à¸¡à¸µà¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¸Šà¸±à¸”à¹€à¸ˆà¸™ (à¸¡à¸²à¸à¸à¸§à¹ˆà¸² 10 à¸„à¸³) **C_Check_Score à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ 2 à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ (à¸«à¹‰à¸²à¸¡à¹€à¸›à¹‡à¸™ 1)**
* **[L4/L5 Full C/A Score]**: à¸–à¹‰à¸² **Extraction_A** à¸¡à¸µà¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¸Šà¸±à¸”à¹€à¸ˆà¸™ (à¸¡à¸²à¸à¸à¸§à¹ˆà¸² 10 à¸„à¸³) **A_Act_Score à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ 2 à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ (à¸«à¹‰à¸²à¸¡à¹€à¸›à¹‡à¸™ 1)**
* à¸à¸²à¸£à¸•à¸±à¸”à¸ªà¸´à¸™à¸œà¹ˆà¸²à¸™/à¹„à¸¡à¹ˆà¸œà¹ˆà¸²à¸™à¸ˆà¸°à¸–à¸¹à¸à¸à¸³à¸«à¸™à¸”à¹‚à¸”à¸¢à¸£à¸°à¸šà¸š:
  - Level 3: score â‰¥ 4
  - Level 4: score â‰¥ 6
  - Level 5: score â‰¥ 8
* L5 Bonus: à¸–à¹‰à¸² PDCA à¸£à¸§à¸¡ â‰¥ 7 à¹à¸¥à¸°à¸¡à¸µà¸«à¸¥à¸±à¸à¸à¸²à¸™à¸£à¸²à¸‡à¸§à¸±à¸¥/à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¸•à¸±à¸§à¹€à¸¥à¸‚/à¸à¸²à¸£à¸¢à¸­à¸¡à¸£à¸±à¸šà¸ à¸²à¸¢à¸™à¸­à¸ â†’ à¹ƒà¸«à¹‰ PDCA à¸ªà¸¹à¸‡à¸ªà¸¸à¸” (score=8)

--- à¸à¸Žà¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸«à¸¥à¸±à¸à¸à¸²à¸™à¹€à¸Šà¸´à¸‡à¸¥à¸š ---
* [NEW] Negative Evidence Rule: à¸«à¸²à¸ Context à¸¡à¸µà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸Šà¸´à¸‡à¸¥à¸š à¹€à¸Šà¹ˆà¸™ 'à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸›à¸£à¸°à¹€à¸¡à¸´à¸™', 'à¸­à¸¢à¸¹à¹ˆà¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£', 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸£à¸´à¹ˆà¸¡', **à¸«à¹‰à¸²à¸¡à¹ƒà¸«à¹‰ C_Check_Score à¸«à¸£à¸·à¸­ A_Act_Score à¹€à¸›à¹‡à¸™ 0 à¸—à¸±à¸™à¸—à¸µ** à¹ƒà¸«à¹‰à¸žà¸´à¸ˆà¸²à¸£à¸“à¸²à¸«à¸¥à¸±à¸à¸à¸²à¸™ P, D à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­ à¸«à¸²à¸à¸à¸²à¸£à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¹‚à¸”à¸¢à¸£à¸§à¸¡à¸¢à¸±à¸‡à¸„à¸‡à¸­à¸¢à¸¹à¹ˆà¸«à¸£à¸·à¸­à¸¡à¸µà¹à¸œà¸™à¸£à¸­à¸‡à¸£à¸±à¸šà¸›à¸±à¸à¸«à¸²à¸”à¸±à¸‡à¸à¸¥à¹ˆà¸²à¸§ à¹ƒà¸«à¹‰à¸žà¸´à¸ˆà¸²à¸£à¸“à¸²à¹ƒà¸«à¹‰à¸„à¸°à¹à¸™à¸™ C/A à¸—à¸µà¹ˆ 1 à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸°à¸—à¹‰à¸­à¸™à¸–à¸¶à¸‡à¸à¸²à¸£à¸£à¸±à¸šà¸£à¸¹à¹‰à¸›à¸±à¸à¸«à¸²
"""

USER_ASSESSMENT_TEMPLATE: Final[str] = """
--- à¹€à¸à¸“à¸‘à¹Œ ---
{sub_criteria_name} ({sub_id}) - Level {level} ({pdca_phase})
--- à¸„à¸³à¸–à¸²à¸¡ ---
{statement_text}
--- à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚ ---
{level_constraint}
--- à¸•à¹‰à¸­à¸‡à¸¡à¸µà¸„à¸³ ---
{must_include_keywords}
--- à¸«à¹‰à¸²à¸¡à¸¡à¸µà¸„à¸³ ---
{avoid_keywords}
--- à¸„à¸§à¸²à¸¡à¸™à¹ˆà¸²à¹€à¸Šà¸·à¹ˆà¸­à¸–à¸·à¸­ ---
Max Rerank Score: {max_rerank_score:.4f} | Evidence Strength: {max_evidence_strength}/10.0
--- à¸«à¸¥à¸±à¸à¸à¸²à¸™ ---
**(à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸: [P], [D], [C], [A] à¸„à¸·à¸­ PDCA Tag à¸—à¸µà¹ˆà¸£à¸°à¸šà¸š Reranker à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¹„à¸§à¹‰)**
{context}
--- à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢ ---
à¸•à¸­à¸š JSON à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ à¹à¸¥à¸° "score" à¸•à¹‰à¸­à¸‡ = P + D + C + A à¹€à¸ªà¸¡à¸­!
{{
  "score": 0,
  "reason": "à¸­à¸˜à¸´à¸šà¸²à¸¢à¸ªà¸±à¹‰à¸™ à¹† à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ (à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 120 à¸„à¸³)",
  "is_passed": false,
  "P_Plan_Score": 0,
  "D_Do_Score": 0,
  "C_Check_Score": 0,
  "A_Act_Score": 0,
  "Extraction_C": "à¸ªà¸£à¸¸à¸›à¸«à¸¥à¸±à¸à¸à¸²à¸™ C (Check) à¸ˆà¸²à¸ Context à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™ '-'",
  "Extraction_A": "à¸ªà¸£à¸¸à¸›à¸«à¸¥à¸±à¸à¸à¸²à¸™ A (Act) à¸ˆà¸²à¸ Context à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™ '-'"
}}
"""

ASSESSMENT_PROMPT = PromptTemplate(
    input_variables=[
        "sub_criteria_name", "sub_id", "level", "pdca_phase",
        "statement_text", "context", "level_constraint",
        "must_include_keywords", "avoid_keywords", 
        "max_rerank_score", "max_evidence_strength"
    ],
    template=SYSTEM_ASSESSMENT_PROMPT + USER_ASSESSMENT_TEMPLATE
)

USER_ASSESSMENT_PROMPT = ASSESSMENT_PROMPT

# =================================================================
# 3. L1-L2 â€” LOW_LEVEL_PROMPT
# =================================================================
SYSTEM_LOW_LEVEL_PROMPT: Final[str] = """
à¸„à¸¸à¸“à¸„à¸·à¸­à¸œà¸¹à¹‰à¸›à¸£à¸°à¹€à¸¡à¸´à¸™ SE-AM Level 1-2 à¸—à¸µà¹ˆà¹€à¸‚à¹‰à¸¡à¸‡à¸§à¸”

""" + GLOBAL_RULES + """

--- à¸à¸Žà¸žà¸´à¹€à¸¨à¸© L1/L2 ---
* score à¸•à¹‰à¸­à¸‡ = P + D + C + A à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
* L1: D_Do_Score = 0, C_Check_Score = 0, A_Act_Score = 0
* L2: C_Check_Score = 0, A_Act_Score = 0
* L1: à¸–à¹‰à¸²à¸¡à¸µà¸«à¸¥à¸±à¸à¸à¸²à¸™à¸—à¸µà¹ˆà¸Šà¸±à¸”à¹€à¸ˆà¸™à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸à¸²à¸£à¸§à¸²à¸‡à¹à¸œà¸™ ({planning_keywords}) â†’ à¹ƒà¸«à¹‰ P_Plan_Score = 2 à¸—à¸±à¸™à¸—à¸µ (à¸«à¹‰à¸²à¸¡à¹ƒà¸«à¹‰ 1 à¸«à¸£à¸·à¸­ 0)
* L2: à¸–à¹‰à¸²à¸¡à¸µà¸«à¸¥à¸±à¸à¸à¸²à¸™à¸à¸²à¸£à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¸•à¸²à¸¡à¹à¸œà¸™ (Do) à¸Šà¸±à¸”à¹€à¸ˆà¸™ â†’ à¹ƒà¸«à¹‰ D_Do_Score = 2 à¸—à¸±à¸™à¸—à¸µ (à¸«à¹‰à¸²à¸¡à¹ƒà¸«à¹‰ 1 à¸«à¸£à¸·à¸­ 0)
"""

USER_LOW_LEVEL_PROMPT_TEMPLATE: Final[str] = """
Sub-Criteria: {sub_id} - {sub_criteria_name}
Level: L{level}
Statement: {statement_text}
Constraints: {level_constraint}
à¸•à¹‰à¸­à¸‡à¸¡à¸µ: {must_include_keywords}
à¸«à¹‰à¸²à¸¡à¸¡à¸µ: {avoid_keywords}
à¸«à¸¥à¸±à¸à¸à¸²à¸™:
{context}
--- à¸„à¸³à¸ªà¸±à¹ˆà¸‡ ---
à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸•à¸²à¸¡à¸à¸Žà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” à¸•à¸­à¸š JSON à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™:
{{
  "score": 0,
  "reason": "à¸ªà¸£à¸¸à¸›à¸ªà¸±à¹‰à¸™ à¹† (à¸ à¸²à¸©à¸²à¹„à¸—à¸¢)",
  "is_passed": false,
  "P_Plan_Score": 0,
  "D_Do_Score": 0,
  "C_Check_Score": 0,
  "A_Act_Score": 0,
  "Extraction_C": "-",
  "Extraction_A": "-"
}}
"""

FULL_LOW_LEVEL_TEMPLATE = SYSTEM_LOW_LEVEL_PROMPT + USER_LOW_LEVEL_PROMPT_TEMPLATE

LOW_LEVEL_PROMPT = PromptTemplate(
    input_variables=[
        "sub_id", "sub_criteria_name", "level", "statement_text",
        "level_constraint", "context", "must_include_keywords", "avoid_keywords",
        "planning_keywords"
    ],
    template=FULL_LOW_LEVEL_TEMPLATE
)

USER_LOW_LEVEL_PROMPT = LOW_LEVEL_PROMPT

# =================================================================
# 4. ACTION PLAN PROMPT
# =================================================================
SYSTEM_ACTION_PLAN_PROMPT: Final[str] = """
à¸„à¸¸à¸“à¸„à¸·à¸­à¸—à¸µà¹ˆà¸›à¸£à¸¶à¸à¸©à¸² Strategic Planning à¸£à¸°à¸”à¸±à¸šà¸ªà¸¹à¸‡à¸ªà¸¸à¸”
à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆ: à¸ªà¸£à¹‰à¸²à¸‡ Action Plan à¸—à¸µà¹ˆà¸›à¸à¸´à¸šà¸±à¸•à¸´à¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡à¸ˆà¸²à¸ Statements à¸—à¸µà¹ˆ Fail à¸«à¸£à¸·à¸­à¸¡à¸µà¸«à¸¥à¸±à¸à¸à¸²à¸™à¸­à¹ˆà¸­à¸™
"""

ACTION_PLAN_TEMPLATE: Final[str] = """
Sub-Criteria: {sub_id}
à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢: Level {target_level}

Statements à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¹à¸à¹‰:
{failed_statements_list}

à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸”à¹‰à¸§à¸¢ JSON Array à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™:

[
  {
    "Statement_ID": "à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡: 1.1.L3",
    "Recommendation_Type": "FAILED à¸«à¸£à¸·à¸­ WEAK_EVIDENCE",
    "Goal": "à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢à¸—à¸µà¹ˆà¸Šà¸±à¸”à¹€à¸ˆà¸™",
    "Actions": ["à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸—à¸µà¹ˆ 1", "à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸—à¸µà¹ˆ 2"],
    "Responsible": "à¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™à¸—à¸µà¹ˆà¸£à¸±à¸šà¸œà¸´à¸”à¸Šà¸­à¸š",
    "Key_Metric": "à¸•à¸±à¸§à¸Šà¸µà¹‰à¸§à¸±à¸”à¸„à¸§à¸²à¸¡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ",
    "Tools_Templates": "à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¡à¸·à¸­/à¹à¸šà¸šà¸Ÿà¸­à¸£à¹Œà¸¡à¸—à¸µà¹ˆà¹à¸™à¸°à¸™à¸³",
    "Verification_Outcome": "à¸«à¸¥à¸±à¸à¸à¸²à¸™à¸—à¸µà¹ˆà¸ˆà¸°à¹ƒà¸Šà¹‰à¸žà¸´à¸ªà¸¹à¸ˆà¸™à¹Œ"
  }
]
"""

ACTION_PLAN_PROMPT = PromptTemplate(
    input_variables=["sub_id", "target_level", "failed_statements_list"],
    template=SYSTEM_ACTION_PLAN_PROMPT + ACTION_PLAN_TEMPLATE
)

# =================================================================
# 5. EVIDENCE DESCRIPTION PROMPT
# =================================================================
SYSTEM_EVIDENCE_DESCRIPTION_PROMPT: Final[str] = """
à¸„à¸¸à¸“à¸„à¸·à¸­à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸ Evidence Analysis
à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆ: à¸ªà¸£à¸¸à¸›à¸«à¸¥à¸±à¸à¸à¸²à¸™à¹à¸¥à¸°à¹ƒà¸«à¹‰à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸—à¸µà¹ˆà¸›à¸à¸´à¸šà¸±à¸•à¸´à¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡
"""

USER_EVIDENCE_DESCRIPTION_TEMPLATE: Final[str] = """
à¹€à¸à¸“à¸‘à¹Œ: {sub_id} Level {level}
à¸«à¸¥à¸±à¸à¸à¸²à¸™:
{context}

à¸•à¸­à¸š JSON à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™:
{{
  "summary": "à¸ªà¸£à¸¸à¸›à¸«à¸¥à¸±à¸à¸à¸²à¸™à¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢",
  "suggestion_for_next_level": "à¸‚à¹‰à¸­à¹à¸™à¸°à¸™à¸³à¸—à¸µà¹ˆà¸—à¸³à¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡à¹€à¸žà¸·à¹ˆà¸­à¹„à¸› Level à¸–à¸±à¸”à¹„à¸›"
}}
"""

EVIDENCE_DESCRIPTION_PROMPT = PromptTemplate(
    input_variables=["sub_id", "level", "context"],
    template=SYSTEM_EVIDENCE_DESCRIPTION_PROMPT + USER_EVIDENCE_DESCRIPTION_TEMPLATE
)

# =================================================================
# 6. Helper selector
# =================================================================
def get_assessment_prompt(level: int) -> PromptTemplate:
    """Return correct prompt based on level"""
    return LOW_LEVEL_PROMPT if level <= 2 else ASSESSMENT_PROMPT