# -*- coding: utf-8 -*-
# core/seam_prompts.py
# SE-AM Prompt Framework v34 ‚Äî Enhanced PDCA Continuity & Action Plan Fix
# ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: 16 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2568 (FIXED: Action Plan Schema Leakage & LLM Logic)

import logging
from langchain_core.prompts import PromptTemplate
from typing import Final, List, Dict, Any
import json
import re
import time
# ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏°‡∏µ ActionPlanActions, ActionPlanResult ‡πÅ‡∏•‡∏∞ logger ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å define ‡πÉ‡∏ô project ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
# from your_models import ActionPlanActions, ActionPlanResult
# from your_utils import logger

logger = logging.getLogger(__name__)

# [NOTE: Since I cannot access your ActionPlanActions model, 
# I am providing the logic to correctly generate the schema string and the revised prompts.]

# =================================================================
# 0. PDCA PHASE MAP
# =================================================================
PDCA_PHASE_MAP: Final[dict[int, str]] = {
    1: "Plan (P)",
    2: "Plan (P) + Do (D)",
    3: "Plan (P) + Do (D) + Check (C)",
    4: "Plan (P) + Do (D) + Check (C) + Act (A)",
    5: "PDCA ‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£ (P + D + C + A) + Sustainability & Innovation"
}

# =================================================================
# 1. GLOBAL HARD RULES
# =================================================================
GLOBAL_RULES: Final[str] = """
‡∏Å‡∏é‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏•‡∏á‡πÇ‡∏ó‡∏©‡πÅ‡∏•‡∏∞ override ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏≤‡∏Å‡∏ù‡πà‡∏≤‡∏ù‡∏∑‡∏ô:

1. ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢ JSON Object ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏î ‡πÜ ‡∏ô‡∏≠‡∏Å JSON
2. ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ```json ‡∏´‡∏£‡∏∑‡∏≠ markdown ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
3. ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ key ‡∏Ñ‡∏£‡∏ö: score, reason, is_passed, P_Plan_Score, D_Do_Score, C_Check_Score, A_Act_Score, Extraction_C, Extraction_A
4. reason ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 120 ‡∏Ñ‡∏≥
5. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‚Üí score = 0 ‡πÅ‡∏•‡∏∞‡∏ó‡∏∏‡∏Å PDCA = 0
6. **‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ P, D ‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÅ‡∏ï‡πà C ‡πÅ‡∏•‡∏∞ A ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô 'Review/Audit' ‡πÅ‡∏•‡∏∞ 'Corrective Action' ‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô**
7. ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô P, D, C, A ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0-2 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
8. **‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ‡∏Ñ‡πà‡∏≤ "score" ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö P_Plan_Score + D_Do_Score + C_Check_Score + A_Act_Score ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!**
9. ‡∏ñ‡πâ‡∏≤ score ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ú‡∏•‡∏£‡∏ß‡∏° PDCA ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ override
10. ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô Level ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (L+1) ‡∏°‡∏≤‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô Level ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (L)
"""

# =================================================================
# 2. L3-L5 ‚Äî ASSESSMENT_PROMPT (MAIN FIX IS HERE)
# =================================================================
SYSTEM_ASSESSMENT_PROMPT: Final[str] = f"""
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô SE-AM Level 3-5 ‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢

{GLOBAL_RULES}

--- ‡∏Ñ‡∏≥‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏° PDCA ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô ---
* P (Plan): ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢ ‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡∏ó‡∏±‡∏®‡∏ô‡πå ‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
* D (Do): ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ ‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°
* C (Check): ‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏ú‡∏•, Audit, ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° KPI/Review, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
* A (Act): ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≤‡∏Å‡∏ú‡∏• C, ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö, ‡∏Å‡∏≤‡∏£‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏Å‡∏≤‡∏£, ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏°‡∏≤‡πÉ‡∏ä‡πâ (Innovation)

--- ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (Evidence Strength) ---
Evidence Strength: {{max_evidence_strength}}/10.0 
(‡∏¢‡∏¥‡πà‡∏á‡∏™‡∏π‡∏á‡∏¢‡∏¥‡πà‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å ‚Äî ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î)

--- ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏™‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô C/A (ENFORCED & FEW-SHOT) ---
**üéØ ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏™‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ô‡πâ‡∏ô)**
1. **Extraction_C (Check):** ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏ú‡∏•/Audit/Review/KPI ‡πÉ‡∏ô Context ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå "Extraction_C"
2. **Extraction_A (Act):** ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏Å‡∏≤‡∏£/‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏° ‡πÉ‡∏ô Context ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå "Extraction_A"

**üõë ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô C/A (Hard Constraint)**
3. **‡∏ñ‡πâ‡∏≤ Extraction_C ‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 10 ‡∏Ñ‡∏≥) ‚Üí C_Check_Score ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 2 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô** (FIX: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 2)
4. **‡∏ñ‡πâ‡∏≤ Extraction_A ‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 10 ‡∏Ñ‡∏≥) ‚Üí A_Act_Score ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 2 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô** (FIX: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 2)
5. ‡∏ñ‡πâ‡∏≤ Extraction_C/A ‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 10 ‡∏Ñ‡∏≥ ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏ß‡∏Å (‡πÄ‡∏ä‡πà‡∏ô '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î‡∏ú‡∏•', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á') ‚Üí C/A_Score ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 1
6. ‡∏Ñ‡πà‡∏≤ "score" ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á P_Plan_Score + D_Do_Score + C_Check_Score + A_Act_Score ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

**üí° ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Few-Shot Guiding (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Format)**
- **Scenario A (PASS L3):** ‡∏ñ‡πâ‡∏≤ Context ‡∏°‡∏µ: "‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô KPI ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•..." ‚Üí **Extraction_C** = "‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô KPI ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ" ‚Üí **C_Check_Score** = 2
- **Scenario B (PASS L4):** ‡∏ñ‡πâ‡∏≤ Context ‡∏°‡∏µ: "‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Audit" ‚Üí **Extraction_A** = "‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏ú‡∏• Audit ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß" ‚Üí **A_Act_Score** = 2
- **Scenario C (FAIL):** ‡∏ñ‡πâ‡∏≤ Context ‡∏°‡∏µ: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£" ‚Üí **Extraction_C** = "-" ‚Üí **C_Check_Score** = 0

--- ‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ï‡∏≤‡∏° Level (CRITICAL FIXES) ---
* **[NEW CRITICAL FIX] ENFORCED P/D SCORE:**
  - **‡∏ñ‡πâ‡∏≤ Context ‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô Plan (P) ‡πÅ‡∏•‡∏∞ Do (D) ‡∏à‡∏≤‡∏Å Level ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‚Üí P_Plan_Score ‡πÅ‡∏•‡∏∞ D_Do_Score ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 2 (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 4 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô) ‡πÄ‡∏ß‡πâ‡∏ô‡πÅ‡∏ï‡πà‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠‡∏°‡∏≤‡∏Å (Evi Str < 5.0) ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÉ‡∏ô Context ‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡∏Å‡∏±‡∏ö P/D ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤**
  - **‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:** ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô $P$ ‡πÅ‡∏•‡∏∞ $D$ ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ $PASS\ L1$ ‡πÅ‡∏•‡∏∞ $L2$ ‡∏ñ‡∏π‡∏Å‡∏£‡∏ß‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô $Context$ ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ $P\_Plan\_Score=2$ ‡πÅ‡∏•‡∏∞ $D\_Do\_Score=2$ ‡πÄ‡∏ß‡πâ‡∏ô‡πÅ‡∏ï‡πà‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á $L3/L4/L5$ ‡∏à‡∏∞‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡∏Å‡∏±‡∏ö $P/D$ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
* **[MAJOR FIX] PDCA Focus:** LLM ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô PDCA ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á Level ‡∏ô‡∏±‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î:
  - **Level 3 (Check/C):** ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏Å (reason) ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á **‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏ú‡∏•/Audit/Review/KPI** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÅ‡∏Å‡∏ô C)
  - **Level 4 (Act/A):** ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏Å (reason) ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á **‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á/‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏¥‡∏á‡∏¢‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÅ‡∏Å‡∏ô A)
  - **Level 5 (Act/Leadership A):** ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏Å (reason) ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á **‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°/‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á (Steering Committee/Executive)** ‡πÅ‡∏•‡∏∞ **‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÑ‡∏õ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ú‡∏• (Scaling/Innovation)** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
* **[NEW] L3 Guardrail:** ‡πÄ‡∏Å‡∏ì‡∏ë‡πå L3: "‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡∏ó‡∏±‡∏®‡∏ô‡πå... ‡πÉ‡∏´‡πâ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à" **‡∏´‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Motivation (‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏á/‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô/‡πÅ‡∏£‡∏á‡∏à‡∏π‡∏á‡πÉ‡∏à) ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô D (Do) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≤‡∏°‡∏ô‡∏≥‡∏°‡∏≤‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô L3**
* L3: ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏´‡πâ A_Act_Score > 0 ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
* ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö:
  - Level 3: score ‚â• 4
  - Level 4: score ‚â• 6
  - Level 5: score ‚â• 8
* L5 Bonus: ‡∏ñ‡πâ‡∏≤ PDCA ‡∏£‡∏ß‡∏° ‚â• 7 ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•/‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç/‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å ‚Üí ‡πÉ‡∏´‡πâ PDCA ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (score=8)

--- ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏ö ---
* [NEW] Negative Evidence Rule: ‡∏´‡∏≤‡∏Å Context ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏ö ‡πÄ‡∏ä‡πà‡∏ô '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô', '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°', **‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏´‡πâ C_Check_Score ‡∏´‡∏£‡∏∑‡∏≠ A_Act_Score ‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ** ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô P, D ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏´‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô C/A ‡∏ó‡∏µ‡πà 1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
"""

USER_ASSESSMENT_TEMPLATE: Final[str] = """
--- ‡πÄ‡∏Å‡∏ì‡∏ë‡πå ---
{sub_criteria_name} ({sub_id}) - Level {level} ({pdca_phase})
--- ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ---
{statement_text}
--- ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ---
{level_constraint}
--- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥ ---
{must_include_keywords}
--- ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥ ---
{avoid_keywords}
--- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠ ---
Max Rerank Score: {max_rerank_score:.4f} | Evidence Strength: {max_evidence_strength}/10.0
--- ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô ---
**(‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: [P], [D], [C], [A] ‡∏Ñ‡∏∑‡∏≠ PDCA Tag ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö Reranker ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏ß‡πâ)**
{context}
--- ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ---
‡∏ï‡∏≠‡∏ö JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞ "score" ‡∏ï‡πâ‡∏≠‡∏á = P + D + C + A ‡πÄ‡∏™‡∏°‡∏≠!
{{
  "score": 0,
  "reason": "‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 120 ‡∏Ñ‡∏≥)",
  "is_passed": false,
  "P_Plan_Score": 0,
  "D_Do_Score": 0,
  "C_Check_Score": 0,
  "A_Act_Score": 0,
  "Extraction_C": "‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô C (Check) ‡∏à‡∏≤‡∏Å Context ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô '-'",
  "Extraction_A": "‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô A (Act) ‡∏à‡∏≤‡∏Å Context ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô '-'"
}}
"""

ASSESSMENT_PROMPT = PromptTemplate(
    input_variables=[
        "sub_criteria_name", "sub_id", "level", "pdca_phase",
        "statement_text", "context", "level_constraint",
        "must_include_keywords", "avoid_keywords", 
        "max_rerank_score", "max_evidence_strength"
    ],
    template=SYSTEM_ASSESSMENT_PROMPT + USER_ASSESSMENT_TEMPLATE
)

USER_ASSESSMENT_PROMPT = ASSESSMENT_PROMPT

# =================================================================
# 3. L1-L2 ‚Äî LOW_LEVEL_PROMPT (No changes needed here based on logs)
# =================================================================
SYSTEM_LOW_LEVEL_PROMPT: Final[str] = """
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô SE-AM Level 1-2 ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î

""" + GLOBAL_RULES + """

--- ‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏© L1/L2 ---
* score ‡∏ï‡πâ‡∏≠‡∏á = P + D + C + A ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
* L1: D_Do_Score = 0, C_Check_Score = 0, A_Act_Score = 0
* L2: C_Check_Score = 0, A_Act_Score = 0
* L1: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô ({planning_keywords}) ‚Üí ‡πÉ‡∏´‡πâ P_Plan_Score = 2 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏´‡πâ 1 ‡∏´‡∏£‡∏∑‡∏≠ 0)
* L2: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô (Do) ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‚Üí ‡πÉ‡∏´‡πâ D_Do_Score = 2 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏´‡πâ 1 ‡∏´‡∏£‡∏∑‡∏≠ 0)
"""

USER_LOW_LEVEL_PROMPT_TEMPLATE: Final[str] = """
Sub-Criteria: {sub_id} - {sub_criteria_name}
Level: L{level}
Statement: {statement_text}
Constraints: {level_constraint}
‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ: {must_include_keywords}
‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ: {avoid_keywords}
‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô:
{context}
--- ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ---
‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ï‡∏≠‡∏ö JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô:
{{
  "score": 0,
  "reason": "‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô ‡πÜ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)",
  "is_passed": false,
  "P_Plan_Score": 0,
  "D_Do_Score": 0,
  "C_Check_Score": 0,
  "A_Act_Score": 0,
  "Extraction_C": "-",
  "Extraction_A": "-"
}}
"""

FULL_LOW_LEVEL_TEMPLATE = SYSTEM_LOW_LEVEL_PROMPT + USER_LOW_LEVEL_PROMPT_TEMPLATE

LOW_LEVEL_PROMPT = PromptTemplate(
    input_variables=[
        "sub_id", "sub_criteria_name", "level", "statement_text",
        "level_constraint", "context", "must_include_keywords", "avoid_keywords",
        "planning_keywords"
    ],
    template=FULL_LOW_LEVEL_TEMPLATE
)

USER_LOW_LEVEL_PROMPT = LOW_LEVEL_PROMPT

# =================================================================
# 4. ACTION PLAN PROMPT (FIXED SCHEMA LEAKAGE LOGIC)
# =================================================================

# *** Helper function to create JSON Schema (Must be defined in your environment) ***
# def get_action_plan_schema_string():
#     # This function must return the JSON Schema string of the desired output (List[ActionPlanActions]).
#     # We use ActionPlanActions.model_json_schema() and clean it up.
#     try:
#         schema_dict = ActionPlanActions.model_json_schema(by_alias=True)
#         schema_dict.pop('$defs', None) 
#         schema_dict.pop('$schema', None) 
#         schema_dict.pop('title', None) 
#         return json.dumps(schema_dict, ensure_ascii=False, indent=2)
#     except Exception:
#         # Use a very simple fallback schema string if model is not accessible
#         return '{"type":"object", "properties":{"Statement_ID":{"type":"string"}, "Goal":{"type":"string"}, "Actions":{"type":"array"}}}'

# NOTE: Since the Schema generation code is in 'create_structured_action_plan' (which I cannot edit directly), 
# I will only provide the final template structure, which is clean.

SYSTEM_ACTION_PLAN_PROMPT: Final[str] = """
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ Strategic Planning ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ‡∏™‡∏£‡πâ‡∏≤‡∏á Action Plan ‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Statements ‡∏ó‡∏µ‡πà Fail ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏≠‡πà‡∏≠‡∏ô
‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏ô‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô PDCA ‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô
"""

ACTION_PLAN_TEMPLATE: Final[str] = """
Sub-Criteria: {sub_id}
‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏•‡∏∏: Level {target_level}
‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡∏•‡∏±‡∏Å: Action Plan ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ô‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏î‡πâ‡∏≤‡∏ô {advice_focus} (Process/Evidence/People)

Statements ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠):
{recommendation_statements_list}

‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢ JSON Array ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà ```json):

[
  {{
    "Statement_ID": "‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 1.1.L3",
    "Recommendation_Type": "FAILED ‡∏´‡∏£‡∏∑‡∏≠ WEAK_EVIDENCE",
    "Goal": "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô",
    "Actions": ["‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1", "‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2"],
    "Responsible": "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö",
    "Key_Metric": "‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
    "Tools_Templates": "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠/‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥",
    "Verification_Outcome": "‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå (‡πÄ‡∏ô‡πâ‡∏ô Evidence P/D/C/A)"
  }}
]
"""
# NOTE: The actual JSON Schema will be injected by the calling function 
# in the production code based on the fix provided in the previous turn.

ACTION_PLAN_PROMPT = PromptTemplate(
    input_variables=["sub_id", "target_level", "recommendation_statements_list", "advice_focus"],
    template=SYSTEM_ACTION_PLAN_PROMPT + ACTION_PLAN_TEMPLATE
)

# =================================================================
# 5. EVIDENCE DESCRIPTION PROMPT (REVISED)
# =================================================================
SYSTEM_EVIDENCE_DESCRIPTION_PROMPT: Final[str] = """
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç Evidence Analysis
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
"""

USER_EVIDENCE_DESCRIPTION_TEMPLATE: Final[str] = """
‡πÄ‡∏Å‡∏ì‡∏ë‡πå: {sub_id}
‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: Level {level}
‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: Level {next_level}

‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö:
{context}

‡∏ï‡∏≠‡∏ö JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô:
{{
  "summary": "‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÉ‡∏ô Level {level} ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô PDCA ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô",
  "suggestion_for_next_level": "‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ Level {next_level} ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô PDCA ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á"
}}
"""

EVIDENCE_DESCRIPTION_PROMPT = PromptTemplate(
    input_variables=["sub_id", "level", "context", "next_level"],
    template=SYSTEM_EVIDENCE_DESCRIPTION_PROMPT + USER_EVIDENCE_DESCRIPTION_TEMPLATE
)

# =================================================================
# 6. Helper selector (REVISED)
# =================================================================
def select_assessment_prompt(level: int) -> PromptTemplate:
    """Select the correct prompt template based on the target level"""
    
    if level <= 2:
        return LOW_LEVEL_PROMPT
    else:
        return ASSESSMENT_PROMPT